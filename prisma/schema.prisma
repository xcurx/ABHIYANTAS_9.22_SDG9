generator client {
    provider = "prisma-client"
    output   = "../generated/prisma"
}

datasource db {
    provider = "postgresql"
}

// ==================== USER & AUTH ====================

model User {
    id            String    @id @default(cuid())
    email         String    @unique
    emailVerified DateTime?
    name          String?
    password      String?
    avatar        String?
    bio           String?
    location      String?
    github        String?
    linkedin      String?
    twitter       String?
    portfolio     String?
    role          UserRole  @default(PARTICIPANT)
    createdAt     DateTime  @default(now())
    updatedAt     DateTime  @updatedAt

    // Relations
    accounts                Account[]
    sessions                Session[]
    organizationMemberships OrganizationMember[]
    // Coding Contest Relations
    contestParticipations ContestParticipant[]
    hackathonRegistrations  HackathonRegistration[]
    notifications           Notification[]
    stageSubmissions        StageSubmission[]
    announcements           Announcement[]
    userSkills              UserSkill[]
}

// ==================== SKILLS ====================

model Skill {
    id          String      @id @default(cuid())
    name        String      @unique
    slug        String      @unique
    category    String?     // e.g., "Programming Language", "Framework", "Cloud", "Database", etc.
    createdAt   DateTime    @default(now())
    
    // Relations
    userSkills  UserSkill[]
    
    @@index([category])
    @@index([name])
}

model UserSkill {
    id          String   @id @default(cuid())
    userId      String
    skillId     String
    proficiency SkillProficiency @default(INTERMEDIATE)
    createdAt   DateTime @default(now())
    
    user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
    skill       Skill    @relation(fields: [skillId], references: [id], onDelete: Cascade)
    
    @@unique([userId, skillId])
    @@index([userId])
    @@index([skillId])
}

enum SkillProficiency {
    BEGINNER
    INTERMEDIATE
    ADVANCED
    EXPERT
}

model Account {
    id                String  @id @default(cuid())
    userId            String
    type              String
    provider          String
    providerAccountId String
    refresh_token     String?
    access_token      String?
    expires_at        Int?
    token_type        String?
    scope             String?
    id_token          String?
    session_state     String?

    user User @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@unique([provider, providerAccountId])
}

model Session {
    id           String   @id @default(cuid())
    sessionToken String   @unique
    userId       String
    expires      DateTime
    user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
    identifier String
    token      String   @unique
    expires    DateTime

    @@unique([identifier, token])
}

enum UserRole {
    SUPER_ADMIN
    ORGANIZATION_ADMIN
    MENTOR
    JUDGE
    PARTICIPANT
    SPONSOR
}

// ==================== ORGANIZATION ====================

model Organization {
    id          String           @id @default(cuid())
    name        String
    slug        String           @unique
    type        OrganizationType
    description String?
    logo        String?
    website     String?
    industry    String?
    size        String?          // e.g., "1-10", "11-50", "51-200", "201-500", "500+"
    location    String?
    isVerified  Boolean          @default(false)
    createdAt   DateTime         @default(now())
    updatedAt   DateTime         @updatedAt

    // Relations
    members OrganizationMember[]
    
    // Coding Contest Relations
    codingContests CodingContest[]
    hackathons Hackathon[]
    stageTemplates StageTemplate[]
}

model OrganizationMember {
    id             String        @id @default(cuid())
    userId         String
    organizationId String
    role           OrgMemberRole @default(MEMBER)
    joinedAt       DateTime      @default(now())

    user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
    organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

    @@unique([userId, organizationId])
}

enum OrganizationType {
    COMPANY
    UNIVERSITY
    NONPROFIT
    GOVERNMENT
    OTHER
}

enum OrgMemberRole {
    OWNER
    ADMIN
    MEMBER
}

// ==================== CODING CONTEST MODULE ====================
// This module is for competitive coding hackathons with MCQ and coding questions

model CodingContest {
    id              String              @id @default(cuid())
    organizationId  String
    title           String
    slug            String              @unique
    description     String?
    shortDescription String?
    bannerImage     String?
    rules           String?
    
    // Timing
    startTime       DateTime
    endTime         DateTime
    duration        Int                 // Duration in minutes (for participant timer)
    
    // Configuration
    status          CodingContestStatus @default(DRAFT)
    visibility      ContestVisibility   @default(PUBLIC)
    maxParticipants Int?
    allowLateJoin   Boolean             @default(false)
    shuffleQuestions Boolean            @default(true)
    showLeaderboard Boolean             @default(true)
    showScoresDuring Boolean            @default(false)
    
    // Proctoring Settings
    proctorEnabled      Boolean         @default(true)
    fullScreenRequired  Boolean         @default(true)
    tabSwitchLimit      Int             @default(3)
    copyPasteDisabled   Boolean         @default(true)
    webcamRequired      Boolean         @default(false)
    
    // Scoring
    negativeMarking   Boolean           @default(false)
    negativePercent   Float             @default(25)
    partialScoring    Boolean           @default(true)
    
    createdAt       DateTime            @default(now())
    updatedAt       DateTime            @updatedAt
    
    // Relations
    organization    Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)
    questions       CodingQuestion[]
    participants    ContestParticipant[]
}

model CodingQuestion {
    id              String          @id @default(cuid())
    contestId       String
    type            QuestionType
    title           String
    description     String          // Rich text / Markdown
    difficulty      Difficulty      @default(MEDIUM)
    points          Int             @default(100)
    order           Int             @default(0)
    timeLimit       Int?            // Optional per-question time limit (seconds)
    memoryLimit     Int?            // Memory limit in MB
    
    // For MCQ
    options         Json?           // Array of {id, text, isCorrect}
    allowMultiple   Boolean         @default(false) // Multiple correct answers
    
    // For Coding Questions
    starterCode     Json?           // {language: code} mapping
    solutionCode    Json?           // Reference solution {language: code}
    constraints     String?
    inputFormat     String?
    outputFormat    String?
    sampleInput     String?
    sampleOutput    String?
    explanation     String?
    hints           String[]        @default([])
    
    // Metadata
    tags            String[]        @default([])
    isActive        Boolean         @default(true)
    createdAt       DateTime        @default(now())
    updatedAt       DateTime        @updatedAt
    
    // Relations
    contest         CodingContest   @relation(fields: [contestId], references: [id], onDelete: Cascade)
    testCases       CodingTestCase[]
    submissions     QuestionSubmission[]
}

model CodingTestCase {
    id          String      @id @default(cuid())
    questionId  String
    input       String      @db.Text
    output      String      @db.Text
    isHidden    Boolean     @default(false)  // Hidden test cases not shown to participants
    isSample    Boolean     @default(false)  // Sample test cases shown in problem
    points      Int         @default(0)      // Points for this test case (partial scoring)
    order       Int         @default(0)
    explanation String?
    
    question    CodingQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)
}

model ContestParticipant {
    id              String              @id @default(cuid())
    contestId       String
    userId          String
    status          ParticipantStatus   @default(REGISTERED)
    startedAt       DateTime?           // When they started the contest
    submittedAt     DateTime?           // When they finished
    lastActiveAt    DateTime?           // Last activity timestamp
    
    // Proctoring Data
    tabSwitchCount  Int                 @default(0)
    isDisqualified  Boolean             @default(false)
    disqualifyReason String?
    
    // Scoring
    totalScore      Float               @default(0)
    questionsAttempted Int              @default(0)
    questionsCorrect   Int              @default(0)
    rank            Int?
    percentile      Float?
    
    // Browser/Environment Info
    browserInfo     String?
    ipAddress       String?
    
    createdAt       DateTime            @default(now())
    updatedAt       DateTime            @updatedAt
    
    // Relations
    contest         CodingContest       @relation(fields: [contestId], references: [id], onDelete: Cascade)
    user            User                @relation(fields: [userId], references: [id], onDelete: Cascade)
    submissions     QuestionSubmission[]
    violations      ProctorViolation[]
    
    @@unique([contestId, userId])
}

model QuestionSubmission {
    id              String          @id @default(cuid())
    participantId   String
    questionId      String
    attemptNumber   Int             @default(1)
    
    // MCQ Answer
    selectedOptions String[]        @default([])
    
    // Coding Answer
    code            String?         @db.Text
    language        String?
    
    // Results
    isCorrect       Boolean?
    score           Float           @default(0)
    testCasesPassed Int             @default(0)
    testCasesTotal  Int             @default(0)
    executionTime   Float?          // Average execution time in ms
    memoryUsed      Float?          // Max memory used in MB
    compileError    String?
    runtimeError    String?
    
    submittedAt     DateTime        @default(now())
    
    // Relations
    participant     ContestParticipant @relation(fields: [participantId], references: [id], onDelete: Cascade)
    question        CodingQuestion     @relation(fields: [questionId], references: [id], onDelete: Cascade)
    testResults     TestCaseResult[]
}

model TestCaseResult {
    id              String      @id @default(cuid())
    submissionId    String
    testCaseIndex   Int         // Index of test case
    passed          Boolean
    actualOutput    String?     @db.Text
    expectedOutput  String?     @db.Text
    executionTime   Float?      // ms
    memoryUsed      Float?      // MB
    status          TestCaseStatus @default(PENDING)
    error           String?
    
    submission      QuestionSubmission @relation(fields: [submissionId], references: [id], onDelete: Cascade)
}

model ProctorViolation {
    id              String          @id @default(cuid())
    participantId   String
    type            ViolationType
    details         String?
    screenshotUrl   String?         // Optional screenshot evidence
    timestamp       DateTime        @default(now())
    
    participant     ContestParticipant @relation(fields: [participantId], references: [id], onDelete: Cascade)
}

// ==================== CODING CONTEST ENUMS ====================

enum CodingContestStatus {
    DRAFT
    PUBLISHED
    REGISTRATION_OPEN
    LIVE
    ENDED
    CANCELLED
}

enum ContestVisibility {
    PUBLIC
    PRIVATE
    INVITE_ONLY
    ORGANIZATION_ONLY
}
// ==================== HACKATHON ====================
model Hackathon {
    id               String          @id @default(cuid())
    title            String
    slug             String          @unique
    description      String
    shortDescription String?
    bannerImage      String?
    thumbnail        String?
    organizationId   String
    type             HackathonType   @default(OPEN)
    mode             HackathonMode   @default(VIRTUAL)
    status           HackathonStatus @default(DRAFT)

    // Dates
    registrationStart DateTime
    registrationEnd   DateTime
    hackathonStart    DateTime
    hackathonEnd      DateTime
    resultsDate       DateTime?

    // Configuration
    maxTeamSize     Int     @default(4)
    minTeamSize     Int     @default(1)
    maxParticipants Int?
    registrationFee Float   @default(0)
    currency        String  @default("USD")

    // Content
    rules       String?
    eligibility String?
    prizePool   Float?
    themes      String[]
    tags        String[]

    // Settings
    allowSoloParticipants Boolean @default(true)
    requireApproval       Boolean @default(false)
    isPublic              Boolean @default(true)
    isFeatured            Boolean @default(false)

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    // Relations
    organization  Organization            @relation(fields: [organizationId], references: [id], onDelete: Cascade)
    tracks        Track[]
    stages        HackathonStage[]
    registrations HackathonRegistration[]
    prizes        Prize[]
    announcements Announcement[]
}

enum HackathonType {
    OPEN
    INVITE_ONLY
    ORGANIZATION_ONLY
}

enum QuestionType {
    MCQ
    CODING
    MULTIPLE_SELECT
    SHORT_ANSWER
}

enum Difficulty {
    EASY
    MEDIUM
    HARD
    EXPERT
}

enum ParticipantStatus {
    REGISTERED
    CHECKED_IN
    IN_PROGRESS
    SUBMITTED
    DISQUALIFIED
    ABSENT
}

enum ViolationType {
    TAB_SWITCH
    WINDOW_BLUR
    COPY_ATTEMPT
    PASTE_ATTEMPT
    RIGHT_CLICK
    FULLSCREEN_EXIT
    DEVTOOLS_OPEN
    SCREEN_CAPTURE_ATTEMPT
    MULTIPLE_DISPLAYS
    SUSPICIOUS_BEHAVIOR
    IDLE_TIMEOUT
}

enum TestCaseStatus {
    PENDING
    RUNNING
    PASSED
    FAILED
    TIME_LIMIT_EXCEEDED
    MEMORY_LIMIT_EXCEEDED
    RUNTIME_ERROR
    COMPILATION_ERROR
}

enum HackathonMode {
    VIRTUAL
    IN_PERSON
    HYBRID
}

enum HackathonStatus {
    DRAFT
    PUBLISHED
    REGISTRATION_OPEN
    REGISTRATION_CLOSED
    IN_PROGRESS
    JUDGING
    COMPLETED
    CANCELLED
}

model Track {
    id          String  @id @default(cuid())
    hackathonId String
    name        String
    description String?
    prizeAmount Float?
    color       String? // Hex color for UI

    hackathon Hackathon @relation(fields: [hackathonId], references: [id], onDelete: Cascade)
}

model Prize {
    id          String  @id @default(cuid())
    hackathonId String
    title       String
    description String?
    amount      Float?
    position    Int // 1st, 2nd, 3rd, etc.
    trackId     String? // Optional: track-specific prize

    hackathon Hackathon @relation(fields: [hackathonId], references: [id], onDelete: Cascade)
}

// ==================== HACKATHON STAGES ====================

model HackathonStage {
    id          String    @id @default(cuid())
    hackathonId String
    name        String
    description String?
    type        StageType
    order       Int // Stage sequence order
    color       String?   // Color for UI display (hex)

    // Timing
    startDate DateTime
    endDate   DateTime

    // Dependencies
    dependsOnStageId String?           // Stage that must complete before this one
    dependsOnStage   HackathonStage?   @relation("StageDependency", fields: [dependsOnStageId], references: [id], onDelete: SetNull)
    dependentStages  HackathonStage[]  @relation("StageDependency")
    allowParallel    Boolean           @default(false) // Can run parallel with other stages

    // Elimination Settings
    isElimination     Boolean          @default(false)
    eliminationType   EliminationType?
    eliminationValue  Float?           // Top N teams, percentage, or score threshold
    eliminationNotes  String?          // Notes about elimination criteria

    // Judging Settings (for EVALUATION stages)
    judgingCriteria   Json?            // Array of {name, description, weight, maxScore}
    minJudgesRequired Int?             // Minimum judges per submission
    blindJudging      Boolean          @default(false)

    // Stage Requirements
    requiresSubmission     Boolean @default(false)
    submissionInstructions String?
    submissionDeadline     DateTime? // Can be different from endDate
    allowLateSubmission    Boolean   @default(false)
    lateSubmissionPenalty  Float?    // Percentage penalty for late submissions

    // Mentoring Settings (for MENTORING_SESSION stages)
    mentorSlotDuration     Int?      // Duration in minutes
    maxSlotsPerTeam        Int?      // Max mentoring slots per team
    
    // Notification Settings
    notifyOnStart          Boolean   @default(true)
    notifyBeforeDeadline   Boolean   @default(true)
    deadlineReminderHours  Int[]     @default([24, 6, 1]) // Hours before deadline to send reminders
    notifyOnComplete       Boolean   @default(true)
    notifyOnElimination    Boolean   @default(true)

    // Status
    isActive    Boolean   @default(true)
    isCompleted Boolean   @default(false)
    completedAt DateTime?

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    // Relations
    hackathon   Hackathon          @relation(fields: [hackathonId], references: [id], onDelete: Cascade)
    submissions StageSubmission[]
    
    @@index([hackathonId, order])
}

// Stage submissions from teams/participants
model StageSubmission {
    id          String   @id @default(cuid())
    stageId     String
    hackathonId String
    userId      String   // Who submitted (team leader or individual)
    teamId      String?  // If team submission
    
    // Submission content
    title       String?
    description String?
    content     String?  // Rich text content
    links       Json?    // Array of {label, url}
    attachments Json?    // Array of {name, url, type, size}
    
    // Status
    status      SubmissionStatus @default(PENDING)
    submittedAt DateTime         @default(now())
    isLate      Boolean          @default(false)
    
    // Judging
    score       Float?
    feedback    String?
    judgedAt    DateTime?
    judgedBy    String?
    
    createdAt   DateTime @default(now())
    updatedAt   DateTime @updatedAt
    
    // Relations
    stage       HackathonStage @relation(fields: [stageId], references: [id], onDelete: Cascade)
    user        User           @relation(fields: [userId], references: [id], onDelete: Cascade)
    
    @@unique([stageId, userId])
    @@index([stageId, status])
}

enum SubmissionStatus {
    PENDING
    SUBMITTED
    UNDER_REVIEW
    APPROVED
    REJECTED
    NEEDS_REVISION
}

enum StageType {
    REGISTRATION
    TEAM_FORMATION
    IDEATION
    MENTORING_SESSION
    CHECKPOINT
    DEVELOPMENT
    EVALUATION
    PRESENTATION
    RESULTS
    CUSTOM
}

enum EliminationType {
    TOP_N // Top N teams advance
    PERCENTAGE // Top X% advance
    SCORE_THRESHOLD // Teams above score threshold advance
}

// Stage Templates for reusability
model StageTemplate {
    id             String    @id @default(cuid())
    organizationId String
    name           String
    description    String?
    type           StageType
    color          String?
    
    // Default duration in hours
    defaultDurationHours Int @default(24)
    
    // Template settings (stored as JSON for flexibility)
    settings       Json      // All the stage settings as a template
    
    isPublic       Boolean   @default(false) // Can other organizations use this?
    usageCount     Int       @default(0)     // How many times used
    
    createdAt      DateTime  @default(now())
    updatedAt      DateTime  @updatedAt
    
    organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
}

// ==================== HACKATHON REGISTRATION ====================

model HackathonRegistration {
    id           String             @id @default(cuid())
    hackathonId  String
    userId       String
    status       RegistrationStatus @default(PENDING)
    registeredAt DateTime           @default(now())
    approvedAt   DateTime?
    rejectedAt   DateTime?
    rejectionReason String?

    hackathon Hackathon @relation(fields: [hackathonId], references: [id], onDelete: Cascade)
    user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@unique([hackathonId, userId])
}

enum RegistrationStatus {
    PENDING
    APPROVED
    REJECTED
    WAITLISTED
    CANCELLED
}

// ==================== ANNOUNCEMENTS & NOTIFICATIONS ====================

model Announcement {
    id          String             @id @default(cuid())
    title       String
    content     String             // Rich text / Markdown content
    type        AnnouncementType   @default(INFO)
    priority    AnnouncementPriority @default(NORMAL)
    
    // Targeting
    hackathonId String?            // If null, it's a platform-wide announcement
    targetAudience TargetAudience  @default(ALL)
    
    // Scheduling
    publishAt   DateTime           @default(now())
    expiresAt   DateTime?          // Optional expiration
    
    // Metadata
    isPinned    Boolean            @default(false)
    isPublished Boolean            @default(true)
    authorId    String
    
    createdAt   DateTime           @default(now())
    updatedAt   DateTime           @updatedAt
    
    // Relations
    hackathon   Hackathon?         @relation(fields: [hackathonId], references: [id], onDelete: Cascade)
    author      User               @relation(fields: [authorId], references: [id])
    notifications Notification[]
    
    @@index([hackathonId])
    @@index([publishAt])
}

model Notification {
    id             String           @id @default(cuid())
    userId         String
    type           NotificationType
    title          String
    message        String
    link           String?          // Optional link to navigate to
    
    // Source reference
    announcementId String?
    hackathonId    String?
    
    // Status
    isRead         Boolean          @default(false)
    readAt         DateTime?
    
    createdAt      DateTime         @default(now())
    
    // Relations
    user           User             @relation(fields: [userId], references: [id], onDelete: Cascade)
    announcement   Announcement?    @relation(fields: [announcementId], references: [id], onDelete: Cascade)
    
    @@index([userId, isRead])
    @@index([userId, createdAt])
}

enum AnnouncementType {
    INFO
    UPDATE
    DEADLINE
    URGENT
    RESULT
    SCHEDULE_CHANGE
}

enum AnnouncementPriority {
    LOW
    NORMAL
    HIGH
    URGENT
}

enum TargetAudience {
    ALL                    // All participants
    REGISTERED             // Only registered participants
    APPROVED               // Only approved participants
    TEAM_LEADERS           // Only team leaders
    MENTORS                // Only mentors
    JUDGES                 // Only judges
    ORGANIZERS             // Only organizers
}

enum NotificationType {
    ANNOUNCEMENT           // From announcement
    REGISTRATION           // Registration status update
    TEAM                   // Team-related notification
    SUBMISSION             // Submission-related
    JUDGING                // Judging/evaluation related
    DEADLINE               // Deadline reminder
    STAGE                  // Stage transition
    SYSTEM                 // System notification
}
